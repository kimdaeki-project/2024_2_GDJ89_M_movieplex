<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "https://mybatis.org/dtd/mybatis-3-mapper.dtd">
  
  <mapper namespace="com.movie.plex.websocket.ChatDAO">
  	<select id="chatRoomList" resultType="ChatRoom">
  		SELECT
		    CHATROOMNO ,
		    TITLE,
		    USERID,
		    (SELECT COUNT(*) FROM CHATROOMJOIN CRJ WHERE CRJ.CHATROOMNO = CR.CHATROOMNO) AS CNT
		FROM CHATROOM CR
		JOIN USERS USING(USERNUM)
		WHERE CR.STATUS = 'Y'
		ORDER BY CHATROOMNO DESC
  	</select>
  	
  	<insert id="addChatRoom" parameterType="ChatRoom">
  		INSERT INTO CHATROOM
		VALUES (CHATROOMNO_SEQ.NEXTVAL, #{title}, 'Y', #{userNum})
  	</insert>
  	
  	<select id="addCheck" parameterType="ChatRoomJoin" resultType="Long">
  		SELECT COUNT(*) FROM CHATROOMJOIN 
		WHERE CHATROOMNO = #{chatRoomNo} AND USERNUM = #{userNum}
  	</select>
  	
  	<insert id="addChatRoomDetail" parameterType="ChatRoomJoin">
  		INSERT INTO CHATROOMJOIN
		VALUES (#{userNum}, #{chatRoomNo})
  	</insert>
  	
  	<select id="chatMessage" parameterType="int" resultType="ChatMessage">
  		SELECT MESSAGE, CREATEDATE, USERID, USERNUM, CMNO FROM CHATMESSAGE
		JOIN USERS
		USING(USERNUM)
		WHERE CHATROOMNO = #{chatRoomNo}
  	</select>
	
	<insert id="insertMessage" parameterType="ChatMessage">
		INSERT INTO CHATMESSAGE
		VALUES (CMNO_SEQ.NEXTVAL, #{message} , SYSDATE, #{chatRoomNo}, #{userNum})
	</insert>
  </mapper>